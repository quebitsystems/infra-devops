---
- name: Install Gateway API CRDs
  shell: k3s kubectl apply -f https://github.com/kubernetes-sigs/gateway-api/releases/download/v1.0.0/standard-install.yaml

- name: Template Kong manifests
  template:
    src: kong-all-in-one.yml.j2
    dest: /tmp/kong-all-in-one.yml
    mode: "0644"

- name: Apply Kong manifests
  shell: k3s kubectl apply -f /tmp/kong-all-in-one.yml
  register: kong_apply

- name: Wait for Kong gateway to be ready
  shell: |
    k3s kubectl wait --for=condition=ready pod -l app=kong,component=gateway -n {{ kong_namespace }} --timeout=300s
  retries: 5
  delay: 15
  register: kong_gw_ready
  until: kong_gw_ready.rc == 0

- name: Wait for Kong controller to be ready
  shell: |
    k3s kubectl wait --for=condition=ready pod -l app=kong,component=controller -n {{ kong_namespace }} --timeout=300s
  retries: 5
  delay: 15
  register: kong_ctrl_ready
  until: kong_ctrl_ready.rc == 0

- name: Apply Kong network policy
  shell: |
    cat <<'EOF' | k3s kubectl apply -f -
    apiVersion: networking.k8s.io/v1
    kind: NetworkPolicy
    metadata:
      name: allow-kong-ingress
      namespace: {{ kong_namespace }}
    spec:
      podSelector:
        matchLabels:
          app: kong
      ingress:
        - ports:
            - protocol: TCP
              port: 8000
            - protocol: TCP
              port: 8443
      policyTypes:
        - Ingress
    EOF

- name: Apply Kong rate-limiting plugin
  shell: |
    cat <<'EOF' | k3s kubectl apply -f -
    apiVersion: configuration.konghq.com/v1
    kind: KongClusterPlugin
    metadata:
      name: global-rate-limit
      annotations:
        kubernetes.io/ingress.class: kong
      labels:
        global: "true"
    config:
      minute: 60
      policy: local
    plugin: rate-limiting
    EOF

- name: Verify Kong pods
  shell: k3s kubectl get pods -n {{ kong_namespace }} -o wide
  register: kong_status

- name: Show Kong status
  debug:
    var: kong_status.stdout_lines

- name: Show Kong services
  shell: k3s kubectl get svc -n {{ kong_namespace }}
  register: kong_svc

- name: Display Kong services
  debug:
    var: kong_svc.stdout_lines

- name: Cleanup temp manifest
  file:
    path: /tmp/kong-all-in-one.yml
    state: absent
